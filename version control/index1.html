<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Iceland Flight</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link href="css/c3.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.2/d3.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/c3/0.4.4/c3.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/d3.v3.js"></script>
    <script type="text/javascript" src="js/canvasjs.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js" charset="utf-8"></script>
</head>

<body style="padding-left: 10px;">

<div class="container-fluid main">
    <div class="row">
        <div class="col-xs-12 bg-none">
            <div class="row" id="toprow">
                <div class="col-xs-12">
                    <h2>Iceland Airline Flows</h2>
                </div>
            </div>

            <div class="row row-map" id="midrow">


                <div class="col-xs-12 col-sm-8 no-col-padding">
                    <!-- Bootstrap-map-js -->
                    <div id="maincontainer">
                        <div id="map"></div>
                        <!--img src=http://win371.ad.utwente.nl/student/s6025366/MigrationOverijssel/legend.png></div-->
                </div>

                <div class="col-xs-12 col-sm-4">
                    <!--<h5>Left 4 (not fixed)</h5>-->
                    <div id="d3chord"></div>
                </div>
            </div>

            <div class="row" id="bottomrow">
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    //Width and height
    var w = 900;
    var h = 600;

    //var timeheight = 80;
    //var centered;

    var formatC = d3.format(",.0f");
    var formatD = d3.format("+,.0f");

    //var immin, immax, exmin, exmax;

    var projection = d3.geo.mercator()
            .center([-22.605556, 63.985])
            .scale(120)
            .translate([w / 2, h / 2]);

    //Define path generator
    var path = d3.geo.path().projection(projection);

    var colors = ["#EDF8FB", "#41083e"];

    var immdomain = [98, 2184]; // min max total number immigrations
    var emmdomain = [146, 2062]; // min max total number emmigrations

    var circleSize = d3.scale.linear().range([0, 500]).domain([0, 5000]);

    var lineSize = d3.scale.linear().range([2, 10]).domain([0, 2500]);

    var fillcolor = d3.scale.linear().range(colors).domain(immdomain);

    //Create SVG element
    var svg = d3.select("#map")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .style("background", "#ffffff");

    var zoom = d3.behavior.zoom()
            .translate([0, 0])
            .scale(1)
            .scaleExtent([1, 8])
            .on("zoom", zoomed);

    var fp = d3.format(".1f");

    //initialize html tooltip
    var tooltip = d3.select("#maincontainer")
            .append("div")
            .attr("id", "tt")
            .style("z-index", "10")
            .style("position", "absolute")
            .style("visibility", "hidden");

    var tooltip2 = d3.select("#maincontainer")
            .append("div")
            .attr("id", "tt2")
            .style("z-index", "10")
            .style("position", "absolute")
            .style("visibility", "hidden");

    var g = svg.append("g");

    //for the zooming
    /*
    svg.append("rect")
            .attr("class", "overlay")
            .attr("width", w)
            .attr("height", h)
            .call(zoom);
            */

    drawBaseMap();
    drawAirports();
    drawAirLines();

    function drawBaseMap() {

        d3.json("data/worldmap.json", function (json) {
            g.selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("class", "state")
                    .attr("id", function (d) {
                        return d.properties.state;
                    })
                    .attr("d", path)
                    .attr("stroke-width", 1)
                    .style("stroke", "#252525")
                    .style("fill", "#f0f0f0");

        });

    }

    function drawAirports() {

        d3.json("data/airport.json", function (airports) {
            //console.log(airports);
            g.selectAll("circle")
                    .data(airports)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) {
                        return projection([d.longitude, d.latitude])[0];
                    })
                    .attr("cy", function (d) {
                        return projection([d.longitude, d.latitude])[1];
                    })
                    .attr("r", 1);
        });

    }

    function drawAirLines() {

        d3.json("data/flowlines.json", function (flights) {

            //console.log(flights);

            flights.forEach(function (d) {

                g.append("path")
                        .attr("stroke", "rgb(60,120,155)")
                        .attr("stroke-width", 0.5)
                        .attr("fill", "none")
                        .attr("opacity", 0.55)
                        .attr("id", "flows")
                        .attr("d", function () {
                            var dx = projection([d.destination.location.longitude, d.destination.location.latitude])[0]
                                            - projection([d.origin.location.longitude, d.origin.location.latitude])[0],
                                    dy = projection([d.destination.location.longitude, d.destination.location.latitude])[1]
                                            - projection([d.origin.location.longitude, d.origin.location.latitude])[1],
                                    dr = Math.sqrt(dx * dx + dy * dy);

                            if (dx < 0) {
                                return "M" + projection([d.destination.location.longitude, d.destination.location.latitude])[0]
                                        + "," + projection([d.destination.location.longitude, d.destination.location.latitude])[1]
                                        + "A" + dr + "," + dr +
                                        " 0 0,1 " + projection([d.origin.location.longitude, d.origin.location.latitude])[0]
                                        + "," + projection([d.origin.location.longitude, d.origin.location.latitude])[1];
                            }
                            else {
                                return "M" + projection([d.origin.location.longitude, d.origin.location.latitude])[0]
                                        + "," + projection([d.origin.location.longitude, d.origin.location.latitude])[1]
                                        + "A" + dr + "," + dr +
                                        " 0 0,1 " + projection([d.destination.location.longitude, d.destination.location.latitude])[0]
                                        + "," + projection([d.destination.location.longitude, d.destination.location.latitude])[1];
                            }

                        })
                        .on("mouseover", function(d, i){

                            d3.select(this).attr("stroke", "#ffff00")
                                    .attr("stroke-width", 2)
                                    .attr("id", "lastselected");
                        })
                        .on("mouseout", function(d, i){
                            d3.select("#lastselected").attr("stroke", "rgb(60,120,155)")
                                    .attr("stroke-width", 0.5)
                                    .attr("id", "flows");
                        });

            });
        });
    }

    function drawAirLines_SimpleLines() {

        d3.json("data/flowlines.json", function (flights) {

            //console.log(flights);

            flights.forEach(function (d) {

                g.append("line")
                        .style("stroke", "#88b2df")
                        .attr("x1", projection([d.origin.location.longitude, d.origin.location.latitude])[0])
                        .attr("y1", projection([d.origin.location.longitude, d.origin.location.latitude])[1])
                        .attr("x2", projection([d.destination.location.longitude, d.destination.location.latitude])[0])
                        .attr("y2", projection([d.destination.location.longitude, d.destination.location.latitude])[1])
                        .attr("stroke-width", 1)
                        .attr("class", "flows")
                        .style("stroke-opacity", 0.2);


            });
        });
    }

    function zoomed() {
        g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        g.select(".state").style("stroke-width", 1 / d3.event.scale);
        g.select(".flows").style("stroke-width", 1 / d3.event.scale);
    }

    d3.select(self.frameElement).style("height", h + "px");

</script>

</body>
</html>