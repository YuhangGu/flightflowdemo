<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Iceland Flight</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link href="css/c3.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.2/d3.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/c3/0.4.4/c3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet'/>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js" charset="utf-8"></script>
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet'/>
    <script src='https://api.mapbox.com/mapbox.js/plugins/arc.js/v0.1.0/arc.js'></script>
    <script type="text/javascript" src="js/d3.v3.js"></script>
    <script type="text/javascript" src="js/canvasjs.min.js"></script>
    <script src='//d3js.org/d3.v3.min.js' charset='utf-8'></script>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 25%;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-overlay .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.20);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay h2 {
            line-height: 24px;
            display: block;
            margin: 0 0 10px;
        }

        .map-overlay .legend .bar {
            height: 10px;
            display: inline-block;
        }

        .map-overlay input {
            background-color: transparent;
            display: inline-block;
            width: 100%;
            position: relative;
            margin: 0;
            cursor: ew-resize;
        }
    </style>
</head>

<body style="padding-left: 10px;">

<div class="container-fluid main">
    <div class="row">
        <div class="col-xs-12 bg-none">

            <div class="row" id="toprow">
                <div class="col-xs-12">
                    <h2>Iceland Airline Flows</h2>
                </div>
            </div>

            <div class="row row-map" id="midrow">
                <div class="col-xs-12 col-sm-12">
                    <!-- Bootstrap-map-js -->
                    <div id="maincontainer">
                        <div id="map" style="height: 800px"></div>
                        <div class='map-overlay top'>
                            <div class='map-overlay-inner'>
                                <h2>Iceland flight 2004-2016</h2>
                                <label id='year'></label>
                                <input id='slider' type='range' min='2004' max='2016' step='1' value='0'/>
                            </div>
                            <div class='map-overlay-inner'>
                                <div id='legend' class='legend'>
                                    <div>Passengers (m)</div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="row" id="bottomrow"></div>
            </div>

        </div>
    </div>
</div>


<script type="text/javascript">

    mapboxgl.accessToken = 'pk.eyJ1IjoiaXRjYWVybyIsImEiOiJjaWxuZmtlOHQwMDA2dnNseWMybHhvMXh0In0.DObc4iUf1_86LxJGF0RHog';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v9',
        center: [8.549167, 47.464722],
        zoom: 1
    });

    var popup = new mapboxgl.Popup({
        closeOnClick: false,
        closeButton: false
    });

    var legend = document.getElementById('legend');
    var yearLabel = document.getElementById('year');

    var layerIDs = [];

    var magnitudes = [
        [0, '#00FFEA'],
        [19, '#E8830C'],
        [100, '#E8A80C'],
        [200, '#B35424'],
        [300, '#C46222']
    ];

    var colorMagnitudes = [];

    var years = [
        '2004',
        '2005',
        '2006',
        '2007',
        '2008',
        '2009',
        '2010',
        '2011',
        '2012',
        '2013',
        '2014',
        '2015',
        '2016'
    ];

    var count = 0;

    function filterBy(year, mag, index) {
        // Clear the popup if displayed.
        popup.remove();

        var filters = [
            "all",
            ["==", "year", year],
            [">=", "seats_1", 0],
            ["<", "seats_1", mag[0]]
        ];
        map.setFilter('flight-' + index, filters);
        yearLabel.textContent = year;
    }

    map.on('load', function () {

        d3.json('data/timeandflow.json', function (err, data) {

            //set scale with color
            var seatmin = d3.min(data.features, function (d) {
                if (d.properties.seats_1 == 0) {
                    return 10000;
                }
                else {
                    return d.properties.seats_1;
                }
            });
            //seatmin  = seatmin + 250;

            var seatmax = d3.max(data.features, function (d) {
                return d.properties.seats_1;
            });


            var color = d3.scale.quantize()
                    .domain([seatmin, seatmax])
                    .range(["#00D1FF","#0197FF" ,"#0D5DFF", "#1010FF"]);

            //print the seats
            //console.log("The least passenger number is: ", seatmin);
            //console.log("The most passenger number is: ", seatmax);

            colorMagnitudes.push([color.invertExtent("#00D1FF")[1], "#00D1FF"]);
            colorMagnitudes.push([color.invertExtent("#0197FF")[1], "#0197FF"]);
            colorMagnitudes.push([color.invertExtent("#0D5DFF")[1], "#0D5DFF"]);
            colorMagnitudes.push([color.invertExtent("#1010FF")[1], "#1010FF"]);

            if (err) throw err;
            data.features = data.features.map(function (d) {
                d.properties.seats_1 = parseInt(d.properties.seats_1);
                d.properties.year = parseInt(d.properties.year);
                return d;
            });

            map.addSource('flights', {
                'type': 'geojson',
                'data': data
            });

            colorMagnitudes.forEach(function (mag, i) {

                var layerID = 'flight-' + i;
                layerIDs.push(layerID);

                map.addLayer({
                    "id": layerID,
                    "type": "line",
                    "source": "flights",
                    "paint": {
                        "line-color": mag[1],
                        "line-opacity": 0.5,
                        "line-width": 0.5
                    }
                });

                filterBy(2004, mag, i);

                var bar = document.createElement('div');
                bar.className = 'bar';
                bar.title = mag[0];
                bar.style.width = 100 / colorMagnitudes.length + '%';
                bar.style.backgroundColor = mag[1];
                legend.insertBefore(bar, legend.firstChild);
            });

            document.getElementById('slider').addEventListener('input', function (e) {
                var year = parseInt(e.target.value, 10);
                //console.log("year is: ", year);
                colorMagnitudes.forEach(function (mag, i) {
                    filterBy(year, mag, i);
                });
            });

             map.on('mousemove', function (e) {
             //console.log("excute mousemove\n");
             var features = map.queryRenderedFeatures(e.point, {layers: layerIDs});
             map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
             });

             map.on('click', function (e) {

             var features = map.queryRenderedFeatures(e.point, {layers: layerIDs});
             if (!features.length) {
             popup.remove();
             return;
             }

             var feature = features[0];
             var link = document.createElement('a');
             link.href = feature.properties.url;
             link.target = '_blank';
             link.textContent = feature.properties.destination_city;

             // Use wrapped coordinates to ensure longitude is within (180, -180)
             var coords = feature.geometry.coordinates;
             var ll = new mapboxgl.LngLat(coords[0][0], coords[1][1]);
             var wrapped = ll.wrap();

             // Center the map to its point.
             map.flyTo({center: wrapped});
             popup.setLngLat(wrapped)
             .setHTML(link.outerHTML)
             .addTo(map);
             });
        });

    });

    // console.log(layerIDs);
</script>

</body>
</html>